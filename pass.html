<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير كلمات المرور الاحترافي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #e2e8f0;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --border-color: #334155;
            --font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .icon-btn {
            background-color: var(--accent-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .icon-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }

        .account-list {
            display: grid;
            gap: 1.5rem;
            animation: listPopIn 0.8s ease-in-out;
        }
        
        @keyframes listPopIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .account-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .account-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .account-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .account-info h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .account-actions {
            display: flex;
            gap: 0.5rem;
        }

        .account-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .account-actions button:hover {
            color: var(--accent-color);
        }

        .password {
            background-color: #0f172a;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
            font-size: 1rem;
        }

        .password .copy-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .password .copy-btn:hover {
            color: #4ade80; /* Green for success */
        }

        .form-container {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .form-container h2 {
            margin-top: 0;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: var(--text-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background-color: #64748b;
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #475569;
        }
        
        .management-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .management-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 0.5rem;
        }

        .biometric-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .biometric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
        }

        /* Biometric Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b, #111827);
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.5s ease-in-out;
            border: 1px solid var(--border-color);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-icon {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .modal-text {
            color: #94a3b8;
        }

        .modal-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1.5rem;
        }

        .modal-btn:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .modal-message {
            margin-top: 1rem;
            font-weight: bold;
        }
        .modal-message.success { color: #4ade80; }
        .modal-message.error { color: #f87171; }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            .header h1 {
                font-size: 1.75rem;
            }
            .icon-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="biometric-modal">
    <div class="modal-content">
        <div class="modal-icon" id="biometric-icon">
            <!-- Icon will be set by JS -->
        </div>
        <h2 id="modal-title"></h2>
        <p class="modal-text" id="modal-description"></p>
        <button class="modal-btn" id="modal-action-btn"></button>
        <div class="modal-message" id="modal-message"></div>
    </div>
</div>

<div class="container" id="main-app" style="display: none;">
    <div class="header">
        <h1>مدير الحسابات</h1>
        <button class="icon-btn" id="add-btn">
            +
        </button>
    </div>

    <div id="add-edit-form" class="form-container" style="display: none;">
        <h2 id="form-title">إضافة حساب جديد</h2>
        <div class="form-group">
            <label for="account-name">اسم الحساب:</label>
            <input type="text" id="account-name" placeholder="مثال: Google">
        </div>
        <div class="form-group">
            <label for="password-value">كلمة المرور:</label>
            <input type="text" id="password-value" placeholder="كلمة المرور">
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" id="save-btn">حفظ</button>
            <button class="btn btn-secondary" id="cancel-btn">إلغاء</button>
        </div>
    </div>
    
    <div id="biometric-management" class="management-section" style="display: none;">
        <h2>إدارة طرق الدخول</h2>
        <div class="biometric-list" id="biometric-list">
            <!-- Biometric methods will be rendered here by JavaScript -->
        </div>
        <button class="btn btn-primary" id="add-biometric-btn" style="margin-top: 1rem; width: 100%;">إضافة طريقة دخول أخرى</button>
        <button class="btn btn-secondary" id="reset-biometric-btn" style="margin-top: 1rem; width: 100%;">إعادة ضبط البصمات</button>
    </div>

    <div class="account-list" id="account-list">
        <!-- Accounts will be rendered here by JavaScript -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const passwordFileContent = `
Warden.zone.contact@gmail.com
saifwalid530@gmail.com
suno.musics.new@gmail.com
contact.us.nee.musics@gmail.com
GGQQWW288@gmail.com
wardenop530@gmail.com
s74519048@gmail.com
warden99118822@gmail.com
contact.us.new.music@gmail.com

ZXCASDQWE123000/*
`;

        // --- Core Application State ---
        let accounts = [];
        let editingId = null;
        let savedCredentials = JSON.parse(localStorage.getItem('biometricCredentials') || '[]');

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const biometricModal = document.getElementById('biometric-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalActionBtn = document.getElementById('modal-action-btn');
        const biometricIcon = document.getElementById('biometric-icon');
        const modalMessage = document.getElementById('modal-message');
        const accountListEl = document.getElementById('account-list');
        const addBtn = document.getElementById('add-btn');
        const addEditForm = document.getElementById('add-edit-form');
        const formTitle = document.getElementById('form-title');
        const accountNameInput = document.getElementById('account-name');
        const passwordValueInput = document.getElementById('password-value');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const biometricManagementSection = document.getElementById('biometric-management');
        const biometricListEl = document.getElementById('biometric-list');
        const addBiometricBtn = document.getElementById('add-biometric-btn');
        const resetBiometricBtn = document.getElementById('reset-biometric-btn');

        // --- Helper Functions ---
        function parsePasswords() {
            const lines = passwordFileContent.trim().split('\n');
            const passwordLine = lines.pop().trim();
            const emails = lines.map(line => line.trim()).filter(Boolean);
            
            return emails.map((email, index) => ({
                id: Date.now() + index,
                email: email,
                password: passwordLine
            }));
        }

        function base64UrlToBinary(base64Url) {
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function binaryToBase64Url(binary) {
            const rawData = String.fromCharCode(...binary);
            return window.btoa(rawData).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // --- WebAuthn Functions ---
        async function registerBiometric(isPrimary) {
            modalActionBtn.disabled = true;
            modalMessage.innerText = 'جاري التسجيل...';
            try {
                // Ensure a valid challenge is generated. This is critical for security.
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge: challenge,
                        rp: { name: "مدير كلمات المرور الاحترافي" },
                        user: {
                            id: new Uint8Array(16),
                            name: `user${Date.now()}@passwords.com`,
                            displayName: isPrimary ? "المستخدم الرئيسي" : "مستخدم إضافي"
                        },
                        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                        authenticatorSelection: { authenticatorAttachment: "platform" },
                        timeout: 60000,
                        attestation: "direct"
                    }
                });

                const newCredential = {
                    id: binaryToBase64Url(new Uint8Array(credential.rawId)),
                    isPrimary: isPrimary,
                    type: 'fingerprint'
                };
                
                savedCredentials.push(newCredential);
                localStorage.setItem('biometricCredentials', JSON.stringify(savedCredentials));
                
                modalMessage.innerText = 'تم التسجيل بنجاح!';
                modalMessage.className = 'modal-message success';
                setTimeout(() => {
                    biometricModal.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderAccounts();
                    renderBiometrics();
                }, 1500);

            } catch (err) {
                console.error('Registration failed:', err);
                let errorMessage = 'فشل التسجيل. حاول مرة أخرى.';
                if (err.name === 'NotAllowedError' || err.message.includes('denied permission')) {
                    errorMessage = 'تم رفض الإذن. تأكد من السماح للمتصفح باستخدام المستشعر.';
                } else if (err.name === 'SecurityError' || err.message.includes('platform')) {
                    errorMessage = 'خطأ أمان. تأكد من أن الموقع على HTTPS أو localhost وأن جهازك يدعم الخدمة.';
                }
                modalMessage.innerText = errorMessage;
                modalMessage.className = 'modal-message error';
                modalActionBtn.disabled = false;
            }
        }

        async function loginBiometric() {
            modalActionBtn.disabled = true;
            modalMessage.innerText = 'جاري التحقق...';
            try {
                if (savedCredentials.length === 0) {
                    modalMessage.innerText = 'لا يوجد بصمة مسجلة. يرجى التسجيل أولاً.';
                    modalMessage.className = 'modal-message error';
                    modalActionBtn.disabled = false;
                    return;
                }
                
                const allowCredentials = savedCredentials.map(cred => ({
                    type: "public-key",
                    id: base64UrlToBinary(cred.id)
                }));

                // Ensure a valid challenge is generated for login
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const assertion = await navigator.credentials.get({
                    publicKey: {
                        challenge: challenge,
                        allowCredentials: allowCredentials,
                        timeout: 60000
                    }
                });

                console.log('Authentication successful.');
                modalMessage.innerText = 'تم التحقق بنجاح!';
                modalMessage.className = 'modal-message success';
                setTimeout(() => {
                    biometricModal.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderAccounts();
                    renderBiometrics();
                }, 1500);

            } catch (err) {
                console.error('Authentication failed:', err);
                let errorMessage = 'فشل التحقق. حاول مرة أخرى.';
                if (err.name === 'NotAllowedError' || err.message.includes('denied permission')) {
                    errorMessage = 'تم رفض الإذن. تأكد من السماح للمتصفح باستخدام المستشعر.';
                } else if (err.name === 'SecurityError' || err.message.includes('platform')) {
                    errorMessage = 'خطأ أمان. تأكد من أن الموقع على HTTPS أو localhost وأن جهازك يدعم الخدمة.';
                } else if (err.name === 'InvalidStateError' && err.message.includes('not recognized')) {
                    errorMessage = 'فشل التحقق. يرجى استخدام إصبع أو وجه مسجل.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'لم يتم العثور على طريقة تسجيل دخول. يرجى التسجيل أولاً.';
                }
                modalMessage.innerText = errorMessage;
                modalMessage.className = 'modal-message error';
                modalActionBtn.disabled = false;
            }
        }

        // --- UI Logic ---
        function showBiometricModal(mode) {
            biometricModal.style.display = 'flex';
            modalMessage.innerText = '';
            
            const isFaceID = window.innerWidth > 768; 
            let iconSvg = '';
            
            if (mode.startsWith('register')) {
                const isBiometricSupported = window.PublicKeyCredential && PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (isBiometricSupported) {
                   iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-fingerprint"><path d="M12 1a10 10 0 1 0 10 10v-1h-2v1a8 8 1 1 1-8-8H2v-1a10 10 0 0 0 10 10z"></path><path d="M12 21a9 9 1 1 1 0-18"></path><path d="M14 10a2 2 1 1 1-4 0v-1a2 2 1 1 1 4 0v1z"></path></svg>`;
                   modalActionBtn.style.display = 'block';
                } else {
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
                    modalDescription.innerText = 'جهازك لا يدعم التحقق البيومتري. يرجى استخدام متصفح وجهاز متوافق.';
                    modalActionBtn.style.display = 'none';
                }
                biometricIcon.innerHTML = iconSvg;
            } else if (mode === 'login') {
                 iconSvg = isFaceID ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-smile"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>` : 
                    `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-fingerprint"><path d="M12 1a10 10 0 1 0 10 10v-1h-2v1a8 8 1 1 1-8-8H2v-1a10 10 0 0 0 10 10z"></path><path d="M12 21a9 9 1 1 1 0-18"></path><path d="M14 10a2 2 1 1 1-4 0v-1a2 2 1 1 1 4 0v1z"></path></svg>`;
                 biometricIcon.innerHTML = iconSvg;
                 modalActionBtn.style.display = 'block';
            }

            if (mode === 'register_primary') {
                modalTitle.innerText = 'تسجيل بصمة اليد الأساسية';
                modalDescription.innerText = 'للدخول الآمن، قم بتسجيل بصمة إصبعك الأساسية. لا يمكن تغييرها.';
                modalActionBtn.innerText = 'بدء التسجيل';
                modalActionBtn.onclick = () => registerBiometric(true);
            } else if (mode === 'login') {
                modalTitle.innerText = 'التحقق للدخول';
                modalDescription.innerText = 'يرجى استخدام بصمتك أو وجهك للمتابعة.';
                modalActionBtn.innerText = 'بدء التحقق';
                modalActionBtn.onclick = loginBiometric;
            } else if (mode === 'register_secondary') {
                modalTitle.innerText = 'إضافة طريقة دخول أخرى';
                modalDescription.innerText = 'يمكنك إضافة بصمة أو وجه آخر للدخول إلى حسابك.';
                modalActionBtn.innerText = 'بدء التسجيل';
                modalActionBtn.onclick = () => registerBiometric(false);
            }
        }

        function renderAccounts() {
            accountListEl.innerHTML = '';
            if (accounts.length === 0) {
                const emptyState = document.createElement('p');
                emptyState.className = 'text-center text-gray-400 mt-8';
                emptyState.innerText = 'لا يوجد حسابات حالياً. استخدم زر الإضافة لإضافة حساب جديد.';
                accountListEl.appendChild(emptyState);
                return;
            }
            
            accounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'account-card';
                card.innerHTML = `
                    <div class="account-info">
                        <h2>${account.email}</h2>
                        <div class="account-actions">
                            <button class="edit-btn" data-id="${account.id}" title="تعديل">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="delete-btn" data-id="${account.id}" title="حذف">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="password">
                        <span class="password-text">${account.password}</span>
                        <button class="copy-btn" data-id="${account.id}" title="نسخ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                `;
                accountListEl.appendChild(card);
            });
        }
        
        function renderBiometrics() {
            biometricListEl.innerHTML = '';
            savedCredentials.forEach(cred => {
                const item = document.createElement('div');
                item.className = 'biometric-item';
                const typeText = cred.type === 'fingerprint' ? 'بصمة الإصبع' : 'Face ID';
                item.innerHTML = `
                    <span>
                        ${cred.isPrimary ? 'البصمة الأساسية' : `طريقة دخول إضافية (${typeText})`}
                    </span>
                    <div>
                        ${!cred.isPrimary ? `<button class="delete-biometric-btn" data-id="${cred.id}" title="حذف"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>` : ''}
                    </div>
                `;
                biometricListEl.appendChild(item);
            });
        }
        
        // --- Event Handlers ---
        addBtn.addEventListener('click', () => {
            editingId = null;
            formTitle.innerText = 'إضافة حساب جديد';
            accountNameInput.value = '';
            passwordValueInput.value = '';
            addEditForm.style.display = 'block';
            addBtn.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            addEditForm.style.display = 'none';
            addBtn.style.display = 'block';
        });

        saveBtn.addEventListener('click', () => {
            const email = accountNameInput.value.trim();
            const password = passwordValueInput.value.trim();
            if (email && password) {
                if (editingId) {
                    const accountToUpdate = accounts.find(acc => acc.id === editingId);
                    if (accountToUpdate) {
                        accountToUpdate.email = email;
                        accountToUpdate.password = password;
                    }
                } else {
                    accounts.unshift({ id: Date.now(), email, password });
                }
                renderAccounts();
                addEditForm.style.display = 'none';
                addBtn.style.display = 'block';
            }
        });

        accountListEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = parseInt(target.dataset.id);

            if (target.classList.contains('delete-btn')) {
                const accountIndex = accounts.findIndex(acc => acc.id === id);
                if (accountIndex !== -1 && accounts[accountIndex].email !== 'Warden.zone.contact@gmail.com') {
                    accounts.splice(accountIndex, 1);
                    renderAccounts();
                } else {
                    alert('لا يمكنك حذف الحساب الأساسي.');
                }
            } else if (target.classList.contains('edit-btn')) {
                const accountToEdit = accounts.find(acc => acc.id === id);
                if (accountToEdit) {
                    editingId = id;
                    formTitle.innerText = 'تعديل الحساب';
                    accountNameInput.value = accountToEdit.email;
                    passwordValueInput.value = accountToEdit.password;
                    addEditForm.style.display = 'block';
                    addBtn.style.display = 'none';
                }
            } else if (target.classList.contains('copy-btn')) {
                const passwordText = target.parentElement.querySelector('.password-text').innerText;
                navigator.clipboard.writeText(passwordText).then(() => {
                    alert('تم نسخ كلمة المرور!');
                });
            }
        });
        
        addBiometricBtn.addEventListener('click', () => {
            showBiometricModal('register_secondary');
        });
        
        biometricListEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target || !target.classList.contains('delete-biometric-btn')) return;
            
            const idToDelete = target.dataset.id;
            
            if (confirm('هل أنت متأكد من حذف طريقة الدخول هذه؟')) {
                savedCredentials = savedCredentials.filter(cred => cred.id !== idToDelete);
                localStorage.setItem('biometricCredentials', JSON.stringify(savedCredentials));
                renderBiometrics();
            }
        });
        
        resetBiometricBtn.addEventListener('click', () => {
            if (confirm('هل أنت متأكد من إعادة ضبط كل طرق الدخول البيومترية؟ ستحتاج إلى التسجيل مرة أخرى.')) {
                localStorage.removeItem('biometricCredentials');
                location.reload();
            }
        });

        // --- Initial App Load ---
        if (savedCredentials.length === 0) {
            accounts = parsePasswords();
            showBiometricModal('register_primary');
        } else {
            accounts = parsePasswords();
            showBiometricModal('login');
        }
    });
</script>

</body>
</html>
